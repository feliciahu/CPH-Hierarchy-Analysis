-- SELECT 
-- DISTINCT LOAD_DT 
-- *
-- FROM SBX_PSAS_DB.ANALYTICS.V_SFDC_CPH_HIERARCHY_CURR WHERE REP_NAME LIKE '%Scott%';

-- SHOW TASKS LIKE 'TSK_FELICIA_H_CPH_SFDC_HIERARCHY_CURR%';
-- DESC TASK TSK_FELICIA_H_CPH_SFDC_HIERARCHY_CURR;
-- execute task TSK_FELICIA_H_CPH_SFDC_HIERARCHY_CURR;

select * from table(SBX_PSAS_DB.INFORMATION_SCHEMA.task_history(
scheduled_time_range_start=>dateadd('day',-7,current_timestamp()),
result_limit => 10,
task_name=>'TSK_FELICIA_H_CPH_SFDC_HIERARCHY_CURR'));
    
-- alter task TSK_FELICIA_H_CPH_SFDC_HIERARCHY_CURR resume; --It was by default suspended  ( run this command Only first time since by default its suspended)

--SALES RESPONSIBILITY HIERARCHY TABLES
--TASK
CREATE OR REPLACE TASK TSK_FELICIA_H_CPH_SFDC_HIERARCHY_CURR
WAREHOUSE = SBX_EA_GENERAL_FR_WH
SCHEDULE = 'USING CRON 30 6 * * 1-5 America/Chicago' -- 6:30 AM on weekdays
TIMESTAMP_INPUT_FORMAT = 'YYYY-MM-DD HH24'
AS

create or replace TABLE SBX_PSAS_DB.SALES_OPS_GOV.V_SFDC_CPH_HIERARCHY_CURR AS 
WITH CURR AS (

--SELECT * FROM SBX_PSAS_DB.ANALYTICS.T_SFDC_CPH_HIERARCHY_TEST

--SELECT * FROM SBX_PSAS_DB.ANALYTICS.V_SFDC_CPH_HIERARCHY_TEST

--create or replace TABLE CURR AS


SELECT cac.CUST_ACCT_ID
	,cac.SLS_TERR_ID
	,cac.HOME_DC_ID
	,COALESCE(sfdc.COMP_FLG, vps.COMP_FLG, 'N') AS COMP_FLG
	,sfdc.REP_NUMBER
	,sfdc.REP_NAME
	,sfdc.REP_TITLE
	,'' AS DSM_NUMBER
	,'' AS DSM_NAME
	,vps.VPS_NUMBER
	,vps.VPS_NAME
	,coalesce(vps.REGION, sfdc.REGION) AS REGION
    ,pro.VP_PRO_NUM AS VP_PRO_NUMBER
    ,pro.VP_PRO_NAME AS VP_PRO_NAME
	,COALESCE(vps.AVP_NUMBER, sfdc.AVP_NUMBER) AS AVP_NUMBER
	,COALESCE(vps.AVP_NAME, sfdc.AVP_NAME) AS AVP_NAME
	,getdate() AS LOAD_DT
FROM PRD_PSAS_DB.RPT.DIM_CUST_ACCT_CURR cac

--Join on non-VPS Sales Responsibilities to get the 'Rep'
LEFT JOIN (
	SELECT sr.ID AS SLS_RESPONSIBILITY_ID
		,sr."NAME" AS SLS_RESPONSIBILITY_NAME
		,sr.TERRITORY__C AS SLS_TERR_ID
		,sr.DC__C AS SLS_DC_ID
		,CASE 
			WHEN sr.COMMISSIONABLE__C = TRUE
				THEN 'Y'
			ELSE 'N'
			END AS COMP_FLG
		,p.EMPID__C AS REP_NUMBER
		,c."NAME" REP_NAME
		,p.TITLE__C AS REP_TITLE
		,p.REGION__C AS REGION
		,avp."NAME" AS AVP_NAME
		,avp.EMPLOYEE_NUMBER__C AS AVP_NUMBER
	--p."NAME"  AS Position_Name, sr.MARKET__C , IS_CURRENT__C , sr.START_DATE__C , sr.END_DATE__C ,
	FROM PRD_DL_MISC_DB.SFDC.SALES_RESPONSIBILITY__C sr
	LEFT JOIN PRD_DL_MISC_DB.SFDC.POSITION__C p ON sr.SALES_POSITION__C = p.ID
	LEFT JOIN PRD_DL_MISC_DB.SFDC.COMPENSATION_PAYEE__C c ON p.CURRENT_SALES_PERSON__C = c.ID
	LEFT JOIN PRD_DL_MISC_DB.SFDC.COMPENSATION_PAYEE__C avp ON p.VPGM__C = avp.ID
	WHERE sr.ISDELETED = FALSE
		AND sr.IS_CURRENT__C = TRUE
		AND sr.TERRITORY__C IS NOT NULL
		--AND sr.COMMISSIONABLE__C = TRUE
		AND sr.MARKET__C IN ('Retail', 'Retail/MHS')
		AND p.TITLE__C <> 'VPS'
	) sfdc ON cac.SLS_TERR_ID = sfdc.SLS_TERR_ID
	AND cac.HOME_DC_ID = sfdc.SLS_DC_ID
	
--Join on the VPS Sales Responsibility to get the 'VPS', 'AVP', 'Region' info	
LEFT JOIN (
	SELECT sr.TERRITORY__C
		,sr.DC__C
		,vps.EMPLOYEE_NUMBER__C AS VPS_NUMBER
		,CASE 
			WHEN sr.COMMISSIONABLE__C = TRUE
				THEN 'Y'
			ELSE 'N'
			END AS COMP_FLG
		,vps."NAME" AS VPS_NAME
		,avp.EMPLOYEE_NUMBER__C AS AVP_NUMBER
		,avp."NAME" AS AVP_NAME
		,p.REGION__C AS REGION
	FROM PRD_DL_MISC_DB.SFDC.SALES_RESPONSIBILITY__C sr
	LEFT JOIN PRD_DL_MISC_DB.SFDC.POSITION__C p ON sr.SALES_POSITION__C = p.ID
	LEFT JOIN PRD_DL_MISC_DB.SFDC.COMPENSATION_PAYEE__C vps ON p.CURRENT_SALES_PERSON__C = vps.ID
	LEFT JOIN PRD_DL_MISC_DB.SFDC.COMPENSATION_PAYEE__C avp ON p.VPGM__C = avp.ID
	WHERE sr.ISDELETED = FALSE
		AND IS_CURRENT__C = TRUE
		AND TERRITORY__C IS NOT NULL
		--AND COMMISSIONABLE__C = TRUE
		AND sr.MARKET__C IN ('Retail', 'Retail/MHS')
		AND p.TITLE__C = 'VPS'
	) vps ON cac.SLS_TERR_ID = vps.TERRITORY__C
	AND cac.HOME_DC_ID = vps.DC__C

--Join on SLS_TERR_ID to get VP PRO
LEFT JOIN (
	SELECT sr.TERRITORY__C
		,vppro.EMPLOYEE_NUMBER__C AS VP_PRO_NUM
		,vppro."NAME" AS VP_PRO_NAME
		,p.REGION__C AS REGION
	FROM PRD_DL_MISC_DB.SFDC.SALES_RESPONSIBILITY__C sr
	LEFT JOIN PRD_DL_MISC_DB.SFDC.POSITION__C p ON sr.SALES_POSITION__C = p.ID
	LEFT JOIN PRD_DL_MISC_DB.SFDC.COMPENSATION_PAYEE__C vppro ON p.CURRENT_SALES_PERSON__C = vppro.ID
	WHERE sr.ISDELETED = FALSE
		AND IS_CURRENT__C = TRUE
		AND TERRITORY__C IS NOT NULL
		--AND COMMISSIONABLE__C = TRUE
		AND sr.MARKET__C IN ('Retail', 'Retail/MHS')
		AND p.TITLE__C = 'VP PRO') pro ON cac.SLS_TERR_ID = pro.TERRITORY__C
	
WHERE cac.CUST_BUS_TYP_CD IN ('01', '02', '05', '13', '24')
	AND cac.ACTIVE_CUST_IND = 'A'
   
    )

--CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.V_SFDC_CPH_HIERARCHY_CURR_TEST AS
SELECT
	CUST_ACCT_ID,
	SLS_TERR_ID,
	HOME_DC_ID,
	COMP_FLG,
	REP_NUMBER,
	REP_NAME,
	REP_TITLE,
	DSM_NUMBER,
	DSM_NAME,
	VPS_NUMBER,
	VPS_NAME,
	REGION,
	VP_PRO_NUMBER,
	VP_PRO_NAME,
	AVP_NUMBER,
	AVP_NAME,
	LOAD_DT
FROM CURR




CREATE VIEW SBX_PSAS_DB.ANALYTICS.V_SFDC_CPH_HIERARCHY_CURR AS
SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.V_SFDC_CPH_HIERARCHY_CURR;

--select * from SBX_PSAS_DB.ANALYTICS.V_SFDC_CPH_HIERARCHY_CURR;
--SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.V_SFDC_CPH_HIERARCHY_CURR

--SELECT * FROM QAT_PSAS_ANALYTICS_DB.GOLD_VARICENT_COMP.VW_OPPRTNTY_ACCTS WHERE CUST_ACCT_ID  IN ('872659','867037')




CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.V_SFDC_CPH_HIERARCHY_HIST as
SELECT *,
DATE_TRUNC(month, CURRENT_DATE()) AS YR_MTH
FROM SBX_PSAS_DB.SALES_OPS_GOV.V_SFDC_CPH_HIERARCHY_CURR;
